{% extends 'base.html' %}
{% block title %}
  Game Development Portfolio
{% endblock %}
{% block content %}
  <div class="container-fluid portfolio-limits">
    <div class="row">
      <!-- Toggle Button for Small Screens -->
      <button class="btn btn-outline-dark d-md-none my-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar-nav">â˜° Contents</button>
      <!-- Sidebar -->
      <nav id="sidebar-nav" class="col-md-3 col-lg-2 d-md-block position-fixed offcanvas-md offcanvas-start navbar" data-bs-scroll="true">
        <div class="offcanvas-header d-md-none">
          <h5 class="offcanvas-title">Contents</h5>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="position-sticky p-3 offcanvas-body">
          <ul class="nav flex-column">
            <a class="navbar-brand d-sm-none d-md-block" href="#">Contents</a>
            <li class="nav-item">
              <a class="nav-link" href="#section1">Section 1</a>
            </li>
            <li class="nav-item">
              <a class="nav-link ml-3 my-1" href="#section1-1">Item 1-1</a>
            </li>
            <li class="nav-item">
              <a class="nav-link ml-3 my-1" href="#section1-2">Item 1-2</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#section2">Section 2</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#section3">Section 3</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#section4">Section 4</a>
            </li>
          </ul>
        </div>
      </nav>

      <div class="content"></div>
      <!-- Main content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <section id="section1">
          <h2 id="">Section 1</h2>
          <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
          <section id="section1-1">
            <h2 id="">Section 1-2</h2>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
          </section>
          <section id="section1-2">
            <h2 id="">Section 1-2</h2>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
          </section>
        </section>
        <section id="section2">
          <h2 id="">Section 2</h2>
          <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
        </section>
        <section id="section3">
          <h2 id="">Section 3</h2>
          <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
        </section>
        <section id="section4">
          <h2 id="">Section 4</h2>
          <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
        </section>
      </main>
    </div>
  </div>

  <!-- Sidebar small screen close button -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var closeButton = document.querySelector('.btn-close')
      closeButton.addEventListener('click', function () {
        var sidebar = document.getElementById('sidebar-nav')
        var bsOffcanvas = bootstrap.Offcanvas.getInstance(sidebar)
        if (bsOffcanvas) {
          bsOffcanvas.hide()
        }
      })
    })
  </script>

  <!-- Sidebar acting lowkey weird fix (scrolls back up after close, adds delay, closes upon section selection) -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const sidebar = document.getElementById('sidebar-nav')
      const navLinks = sidebar.querySelectorAll('.nav-link')
    
      function handleNavLinkClick(event) {
        event.preventDefault()
    
        const targetId = this.getAttribute('href').substring(1)
        const targetElement = document.getElementById(targetId)
    
        if (targetElement) {
          let bsOffcanvas = bootstrap.Offcanvas.getInstance(sidebar)
    
          const afterOffcanvasHidden = () => {
            targetElement.scrollIntoView({ behavior: 'smooth' })
            sidebar.removeEventListener('hidden.bs.offcanvas', afterOffcanvasHidden) // Important: Remove the listener
          }
    
          if (bsOffcanvas && bsOffcanvas._isShown) {
            // Check if offcanvas is shown
            sidebar.addEventListener('hidden.bs.offcanvas', afterOffcanvasHidden)
            bsOffcanvas.hide()
          } else {
            targetElement.scrollIntoView({ behavior: 'smooth' }) // For non-offcanvas or already hidden
          }
        }
      }
    
      // Attach event listeners ONCE, but use a function to handle clicks
      navLinks.forEach((link) => {
        link.addEventListener('click', handleNavLinkClick)
      })
    
      // Intersection Observer (Active States) - Keep this code as it was
      // ... (Your Intersection Observer code here) ...
    
      // Mutation Observer to handle dynamic changes in the DOM
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class' && mutation.target === sidebar) {
            // Check if the sidebar's class changed (e.g., from offcanvas to regular)
            // Re-attach event listeners to .nav-link elements
            navLinks.forEach((link) => {
              link.removeEventListener('click', handleNavLinkClick) // Remove old listener
              link.addEventListener('click', handleNavLinkClick) // Add new listener
            })
          }
        })
      })
    
      observer.observe(sidebar, { attributes: true })
    })
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var sections = document.querySelectorAll('main section')
      var navLinks = document.querySelectorAll('#sidebar-nav .nav-link')
    
      // Detect parent-child relationships dynamically
      let sectionHierarchy = {}
      sections.forEach((section) => {
        let id = section.getAttribute('id')
        let parentId = id.includes('-') ? id.split('-')[0] : null // Extract parent part
        if (parentId && document.getElementById(parentId)) {
          sectionHierarchy[id] = parentId // Map child to parent
        }
      })
    
      let observer = new IntersectionObserver(
        (entries) => {
          let activeSections = new Set()
    
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              let sectionId = entry.target.getAttribute('id')
              activeSections.add(sectionId)
    
              // If a child section is active, mark its parent as well
              if (sectionHierarchy[sectionId]) {
                activeSections.add(sectionHierarchy[sectionId])
              }
            }
          })
    
          // Update sidebar links
          navLinks.forEach((link) => {
            let linkHref = link.getAttribute('href').substring(1) // Remove #
            if (activeSections.has(linkHref)) {
              link.classList.add('active')
            } else {
              link.classList.remove('active')
            }
          })
        },
        { rootMargin: '-10% 0px -90% 0px', threshold: 0 }
      )
    
      sections.forEach((section) => observer.observe(section))
    })
  </script>
{% endblock %}
